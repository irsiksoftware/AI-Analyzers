name: Discord Notifications

on:
  push:
  pull_request:
    types: [opened, closed]
  release:
    types: [published]

jobs:
  notify-commit:
    if: github.event_name == 'push'
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Send Discord notification for commit
        shell: powershell
        env:
          DISCORD_WEBHOOK: ${{ secrets.COMMIT_WEBHOOK }}
        run: |
          $commitMessage = ("${{ github.event.head_commit.message }}" -split "`n")[0]
          $commitUrl = "${{ github.event.head_commit.url }}"
          $author = "${{ github.event.head_commit.author.name }}"
          $repo = "${{ github.repository }}"
          $branch = "${{ github.ref_name }}"

          $payload = @{
            embeds = @(
              @{
                title = "New Commit to $repo"
                description = $commitMessage
                url = $commitUrl
                color = 5814783
                fields = @(
                  @{
                    name = "Author"
                    value = $author
                    inline = $true
                  }
                  @{
                    name = "Branch"
                    value = $branch
                    inline = $true
                  }
                )
                timestamp = "${{ github.event.head_commit.timestamp }}"
              }
            )
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body $payload -ContentType "application/json"

  notify-pull-request:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || (github.event.action == 'closed' && github.event.pull_request.merged == true))
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: Send Discord notification for opened PR
        if: github.event.action == 'opened'
        shell: powershell
        env:
          WEBHOOK_URL: ${{ secrets.PULLREQUEST_WEBHOOK }}
        run: |
          $payload = @{
            embeds = @(
              @{
                title = "Pull Request Opened"
                description = "${{ github.event.pull_request.title }}"
                color = 3447003
                fields = @(
                  @{
                    name = "Author"
                    value = "${{ github.event.pull_request.user.login }}"
                    inline = $true
                  }
                  @{
                    name = "Branch"
                    value = "``${{ github.event.pull_request.head.ref }}`` → ``${{ github.event.pull_request.base.ref }}``"
                    inline = $true
                  }
                  @{
                    name = "Status"
                    value = "Ready for Review"
                    inline = $true
                  }
                )
                url = "${{ github.event.pull_request.html_url }}"
                timestamp = "${{ github.event.pull_request.created_at }}"
                footer = @{
                  text = "PR #${{ github.event.pull_request.number }}"
                }
              }
            )
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri $env:WEBHOOK_URL -Method Post -Body $payload -ContentType "application/json"
          Write-Host "Discord notification sent for opened PR!"

      - name: Send Discord notification for merged PR
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        shell: powershell
        env:
          WEBHOOK_URL: ${{ secrets.PULLREQUEST_WEBHOOK }}
        run: |
          $payload = @{
            embeds = @(
              @{
                title = "Pull Request Merged"
                description = "${{ github.event.pull_request.title }}"
                color = 5763719
                fields = @(
                  @{
                    name = "Author"
                    value = "${{ github.event.pull_request.user.login }}"
                    inline = $true
                  }
                  @{
                    name = "Merged By"
                    value = "${{ github.event.pull_request.merged_by.login }}"
                    inline = $true
                  }
                  @{
                    name = "Branch"
                    value = "``${{ github.event.pull_request.head.ref }}`` → ``${{ github.event.pull_request.base.ref }}``"
                    inline = $true
                  }
                  @{
                    name = "Commits"
                    value = "${{ github.event.pull_request.commits }}"
                    inline = $true
                  }
                  @{
                    name = "Changed Files"
                    value = "${{ github.event.pull_request.changed_files }}"
                    inline = $true
                  }
                  @{
                    name = "Status"
                    value = "Successfully Merged"
                    inline = $true
                  }
                )
                url = "${{ github.event.pull_request.html_url }}"
                timestamp = "${{ github.event.pull_request.merged_at }}"
                footer = @{
                  text = "PR #${{ github.event.pull_request.number }}"
                }
              }
            )
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri $env:WEBHOOK_URL -Method Post -Body $payload -ContentType "application/json"
          Write-Host "Discord notification sent for merged PR!"

  notify-release:
    if: github.event_name == 'release'
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Send Discord notification for release
        shell: powershell
        env:
          DISCORD_WEBHOOK: ${{ secrets.RELEASE_WEBHOOK }}
        run: |
          $releaseName = "${{ github.event.release.name }}"
          $releaseTag = "${{ github.event.release.tag_name }}"
          $releaseUrl = "${{ github.event.release.html_url }}"
          $releaseBodyFull = "${{ github.event.release.body }}"
          $releaseBody = if ($releaseBodyFull.Length -gt 500) { $releaseBodyFull.Substring(0, 500) + "..." } else { $releaseBodyFull }
          $author = "${{ github.event.release.author.login }}"
          $branch = "${{ github.event.release.target_commitish }}"

          $payload = @{
            embeds = @(
              @{
                title = "New Release: $releaseName"
                description = $releaseBody
                url = $releaseUrl
                color = 3066993
                fields = @(
                  @{
                    name = "Version"
                    value = $releaseTag
                    inline = $true
                  }
                  @{
                    name = "Released by"
                    value = $author
                    inline = $true
                  }
                  @{
                    name = "Branch"
                    value = $branch
                    inline = $true
                  }
                )
                timestamp = "${{ github.event.release.published_at }}"
              }
            )
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body $payload -ContentType "application/json"
