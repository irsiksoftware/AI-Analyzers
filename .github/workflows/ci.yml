name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: [self-hosted, Windows, dotnet]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation

      - name: Calculate Version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $version = $Matches[1]
            $isRelease = 'true'
          } else {
            # Get latest tag or default to 0.0.0.0
            $latestTag = git describe --tags --abbrev=0 2>$null
            if ($latestTag -match '^v(.+)$') {
              $baseVersion = $Matches[1]
            } else {
              $baseVersion = '0.0.0.0'
            }
            # Count commits since tag (or all commits if no tag)
            $commitCount = git rev-list --count HEAD
            $version = "$baseVersion-dev.$commitCount"
            $isRelease = 'false'
          }
          Write-Host "Version: $version"
          Write-Host "IsRelease: $isRelease"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "is_release=$isRelease" >> $env:GITHUB_OUTPUT

      - name: Restore
        run: dotnet restore IrsikSoftware.Analyzers.slnx

      - name: Build
        run: dotnet build IrsikSoftware.Analyzers.slnx -c Release --no-restore -p:Version=${{ steps.version.outputs.version }}

      - name: Copy DLLs to UPM Package
        shell: pwsh
        run: |
          $upmAnalyzersDir = "packages/com.irsik.analyzers.unity/Analyzers"

          # Ensure directory exists
          if (-not (Test-Path $upmAnalyzersDir)) {
            New-Item -ItemType Directory -Path $upmAnalyzersDir -Force
          }

          # Copy Core and Unity analyzer DLLs
          Copy-Item "src/IrsikSoftware.Analyzers.Core/bin/Release/netstandard2.0/IrsikSoftware.Analyzers.Core.dll" $upmAnalyzersDir -Force
          Copy-Item "src/IrsikSoftware.Analyzers.Unity/bin/Release/netstandard2.0/IrsikSoftware.Analyzers.Unity.dll" $upmAnalyzersDir -Force

          Write-Host "Copied DLLs to UPM package:"
          Get-ChildItem $upmAnalyzersDir

      - name: Update UPM package.json version
        if: steps.version.outputs.is_release == 'true'
        shell: pwsh
        run: |
          $packageJson = Get-Content "packages/com.irsik.analyzers.unity/package.json" -Raw | ConvertFrom-Json
          $packageJson.version = "${{ steps.version.outputs.version }}"
          $packageJson | ConvertTo-Json -Depth 10 | Set-Content "packages/com.irsik.analyzers.unity/package.json"
          Write-Host "Updated package.json version to ${{ steps.version.outputs.version }}"

      - name: Upload NuGet Packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: src/**/bin/Release/*.nupkg
          retention-days: 30

      - name: Upload UPM Package
        uses: actions/upload-artifact@v4
        with:
          name: upm-package
          path: packages/com.irsik.analyzers.unity/
          retention-days: 30

  release:
    needs: build
    runs-on: [self-hosted, Windows, dotnet]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download NuGet Packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: packages

      - name: Download UPM Package
        uses: actions/download-artifact@v4
        with:
          name: upm-package
          path: upm-package

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/**/*.nupkg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
